import tkinter as tk
from tkinter import ttk, filedialog
import json
import requests
from threading import Thread


class CodeAnalyzerApp:
    def __init__(self, master):
        self.master = master
        master.title("AIä»£ç å®‰å…¨åˆ†æå™¨ v1.0")

        # ç•Œé¢å¸ƒå±€
        self.model_endpoint = "http://localhost:11434/api/generate"
        self.supported_langs = ["C/C++", "Java", "Python", "PHP", "Go", "JavaScript"]
        self.create_widgets()

    def create_widgets(self):
        # ä»£ç è¾“å…¥åŒº
        self.code_text = tk.Text(self.master, height=20, width=80)
        self.code_text.grid(row=0, column=0, padx=10, pady=10)

        # æ§åˆ¶é¢æ¿
        control_frame = ttk.Frame(self.master)
        control_frame.grid(row=1, column=0, sticky="w")

        # è¯­è¨€é€‰æ‹©
        self.lang_var = tk.StringVar()
        lang_label = ttk.Label(control_frame, text="ä»£ç è¯­è¨€:")
        lang_label.grid(row=0, column=0, padx=5)
        self.lang_menu = ttk.Combobox(control_frame,
                                      textvariable=self.lang_var,
                                      values=self.supported_langs)
        self.lang_menu.grid(row=0, column=1)
        self.lang_menu.current(0)

        # æ–‡ä»¶é€‰æ‹©
        ttk.Button(control_frame,
                   text="é€‰æ‹©æ–‡ä»¶",
                   command=self.load_file).grid(row=0, column=2, padx=5)

        # åˆ†ææŒ‰é’®
        ttk.Button(control_frame,
                   text="å¼€å§‹åˆ†æ",
                   command=self.start_analysis).grid(row=0, column=3, padx=5)

        # ç»“æœæ˜¾ç¤º
        self.result_text = tk.Text(self.master, height=10, width=80)
        self.result_text.grid(row=2, column=0, padx=10, pady=10)

    def load_file(self):
        filepath = filedialog.askopenfilename(
            filetypes=[("All Files", "*.*")])
        if filepath:
            with open(filepath, 'r') as f:
                self.code_text.delete(1.0, tk.END)
                self.code_text.insert(tk.END, f.read())

    def generate_prompt(self, code, lang):
        return f"""è¯·ä¸¥æ ¼æŒ‰ä»¥ä¸‹JSONæ ¼å¼å¯¹{lang}ä»£ç è¿›è¡Œå®‰å…¨å®¡è®¡ï¼š
'''{lang.lower()}
{code}
        è¾“å‡ºè¦æ±‚ï¼š
        {{
        "code_metadata": {{
        "language": "{lang}",
        "total_lines": [ä»£ç æ€»è¡Œæ•°]
        }},
        "vulnerabilities": [
        {{
        "type": "æ¼æ´ç±»å‹",
        "severity": "é«˜å±/ä¸­å±/ä½å±",
        "line_numbers": [è¡Œå·æ•°ç»„],
        "description": "é£é™©æè¿°",
        "suggestion": "ä¿®å¤å»ºè®®"
        }}
        ],
        "summary": {{
        "high_risk": [é«˜å±æ•°é‡],
        "medium_risk": [ä¸­å±æ•°é‡],
        "low_risk": [ä½å±æ•°é‡]
        }}
        }}
        """

    def show_error(self, msg):
        self.result_text.delete(1.0, tk.END)
        self.result_text.insert(tk.END, f"é”™è¯¯: {msg}")

    def analyze_code(self):
        code = self.code_text.get(1.0, tk.END)

        lang = self.lang_var.get()

        # ä¿®æ­£è¯·æ±‚å‚æ•°çš„ç¼©è¿›å’Œæ ¼å¼
        try:
            prompt = self.generate_prompt(code, lang)
            response = requests.post(
                self.model_endpoint,
                json={
                    "model": "deepseek-r1:8b",  # ç»Ÿä¸€ç¼©è¿›
                    "options": {"num_ctx": 4096, "num_predict": 1024},  # å‚æ•°é™åˆ¶
                    "prompt": prompt,
                    "format": "json",
                    "stream": False
                }
            )
            result = json.loads(response.json()["response"])
            self.master.after(0, self.display_result, result)

        except Exception as e:
            self.master.after(0, lambda: self.show_error(str(e)))

    def display_result(self, result):
        self.code_text.tag_remove("vul_line", 1.0, tk.END)
        self.result_text.delete(1.0, tk.END)

        # 1. æ˜¾ç¤ºåŸºç¡€ä¿¡æ¯
        metadata = result.get("code_metadata", {})
        self.result_text.insert(tk.END,
                                f"ğŸ” åˆ†ææŠ¥å‘Š | è¯­è¨€: {metadata.get('language', 'æœªçŸ¥')} | "
                                f"å‹ç¼©åä»£ç æœ‰æ•ˆè¡Œæ•°: {metadata.get('total_lines', 0)}\n", "header")

        # 2. æ¼æ´åˆ†ç±»å±•ç¤º
        vul_table = ttk.Treeview(self.result_text, columns=('type', 'severity', 'lines', 'action'), show='headings')
        vul_table.heading('type', text='æ¼æ´ç±»å‹')
        vul_table.heading('severity', text='å±é™©ç­‰çº§')
        vul_table.heading('lines', text='å½±å“è¡Œå·')
        vul_table.heading('action', text='æ“ä½œ')

        # 3. é¢œè‰²æ ‡ç­¾å®šä¹‰
        severity_color = {
            "é«˜å±": "#ff4444",
            "ä¸­å±": "#ffa500",
            "ä½å±": "#4CAF50"
        }

        for vul in result.get("vulnerabilities", []):
            line_nums = ", ".join(map(str, vul.get("line_numbers", [])))
            vul_table.insert('', 'end',
                             values=(
                                 vul.get("type", "æœªçŸ¥"),
                                 vul.get("severity", "æœªçŸ¥"),
                                 line_nums,
                                 "æŸ¥çœ‹è¯¦æƒ…"
                             ),
                             tags=(vul["severity"],)
                             )

        # 4. äº¤äº’åŠŸèƒ½ï¼šç‚¹å‡»è¡Œè·³è½¬åˆ°ä»£ç 
        def on_vul_select(event):
            item = vul_table.selection()[0]
            line_nums = vul_table.item(item, "values")[2].split(", ")
            self.code_text.tag_remove("highlight", 1.0, tk.END)
            for line in line_nums:
                if line.isdigit():
                    start = f"{line}.0"
                    end = f"{int(line) + 1}.0"
                    self.code_text.tag_add("highlight", start, end)
            self.code_text.see(f"{line}.0")  # è‡ªåŠ¨æ»šåŠ¨åˆ°å¯¹åº”è¡Œ

        vul_table.bind("<Double-1>", on_vul_select)

        # 5. æ ·å¼é…ç½®
        self.result_text.window_create(tk.END, window=vul_table)
        for sev, color in severity_color.items():
            vul_table.tag_configure(sev, background=color, foreground="white")

        # é…ç½®æ–‡æœ¬æ ·å¼
        self.result_text.tag_config("header", font=('å¾®è½¯é›…é»‘', 11, 'bold'))
        self.result_text.tag_config("summary", foreground="#2196F3")

    def start_analysis(self):
        """ æ ¸å¿ƒï¼šå¯åŠ¨åˆ†æçº¿ç¨‹ """
        # æ¸…ç©ºæ—§ç»“æœ
        self.result_text.delete(1.0, tk.END)
        self.result_text.insert(tk.END, "åˆ†æä¸­ï¼Œè¯·ç¨å€™...\n")

        # å¯åŠ¨åå°çº¿ç¨‹é˜²æ­¢GUIå¡æ­»
        Thread(target=self.analyze_code).start()

# ä¿®æ­£ä¸»ç¨‹åºå…¥å£
if __name__ == "__main__":  # æ·»åŠ åŒä¸‹åˆ’çº¿
    root = tk.Tk()
    app = CodeAnalyzerApp(root)
    root.mainloop()

